---
title: React å¤–éƒ¨çŠ¶æ€åŒæ­¥æ–¹æ¡ˆ
tags: [ConcurrentRendering, Performance, React, ReactHooks, StateManagement, useSyncExternalStore]
summary: æœ¬æ–‡æ·±åº¦å‰–æäº† React 18 å¼•å…¥çš„æ ¸å¿ƒ Hook useSyncExternalStoreï¼Œæ—¨åœ¨è§£å†³ä¸å¤–éƒ¨æ•°æ®æºåŒæ­¥æ—¶äº§ç”Ÿçš„â€œæ’•è£‚ (tearing)â€ã€SSR æ°´åˆä¸åŒ¹é…åŠæ€§èƒ½é—®é¢˜ã€‚ç¬”è®°ç³»ç»Ÿæ€§åœ°é˜è¿°äº†è¯¥ Hook ç›¸è¾ƒäºä¼ ç»Ÿ useEffect æ¨¡å¼çš„ä¼˜åŠ¿ï¼Œæ‹†è§£äº†å…¶åŸºäº subscribe å’Œ getSnapshot çš„åŸå­åŒ–æ›´æ–°æœºåˆ¶ï¼Œå¹¶æä¾›äº†å…·ä½“çš„å®ç°èŒƒä¾‹ã€‚
date: 2025-08-10
lastmod: 2025-08-10
draft: false
---
åœ¨ React åº”ç”¨ä¸­ï¼Œç»„ä»¶çŠ¶æ€é€šå¸¸ç”± React è‡ªèº«ç®¡ç†ã€‚ç„¶è€Œï¼Œå½“ç»„ä»¶éœ€è¦è®¢é˜…å¹¶å“åº”å­˜åœ¨äº React ç»„ä»¶æ ‘**å¤–éƒ¨**çš„æ•°æ®æºæ—¶â€”â€”ä¾‹å¦‚ç¬¬ä¸‰æ–¹çŠ¶æ€ç®¡ç†åº“ã€æµè§ˆå™¨ API æˆ–å®æ—¶çš„ WebSocket æ•°æ®æµâ€”â€”çŠ¶æ€åŒæ­¥çš„å¤æ‚æ€§ä¾¿ä¼šæ˜¾è‘—å¢åŠ ã€‚ä¼ ç»Ÿçš„ `useEffect` ä¸ `useState` ç»„åˆæ¨¡å¼åœ¨è¿™ç§åœºæ™¯ä¸‹å­˜åœ¨å›ºæœ‰çš„ç¼ºé™·ï¼Œå¯èƒ½å¯¼è‡´æ¸²æŸ“ä¸ä¸€è‡´å’Œæ€§èƒ½é—®é¢˜ã€‚ä¸ºæ­¤ï¼ŒReact 18 æ­£å¼å¼•å…¥äº† **`useSyncExternalStore`** Hookï¼Œä¸ºå¼€å‘è€…æä¾›äº†ä¸€ä¸ªç”¨äºå®‰å…¨ã€é«˜æ•ˆåœ°è®¢é˜…å¤–éƒ¨æ•°æ®æºçš„æƒå¨è§£å†³æ–¹æ¡ˆã€‚

# ä¼ ç»Ÿæ¨¡å¼çš„å›°å¢ƒï¼š`useEffect` ä¸ `useState`

åœ¨ `useSyncExternalStore` å‡ºç°ä¹‹å‰ï¼Œè®¢é˜…å¤–éƒ¨æ•°æ®æºçš„å…¸å‹æ¨¡å¼å¦‚ä¸‹ï¼š

```js
import { useState, useEffect } from 'react';
import { externalStore } from './myStore.js';

function MyComponent() {
  // 1. ä½¿ç”¨ useState å­˜å‚¨å¤–éƒ¨ store çš„ä¸€ä»½å‰¯æœ¬
  const [state, setState] = useState(externalStore.getSnapshot());

  useEffect(() => {
    // 2. è®¢é˜…å˜æ›´ï¼Œå¹¶åœ¨å˜æ›´æ—¶æ›´æ–°ç»„ä»¶ state
    const unsubscribe = externalStore.subscribe(() => {
      setState(externalStore.getSnapshot());
    });
    
    // 3. åœ¨ç»„ä»¶å¸è½½æ—¶å–æ¶ˆè®¢é˜…
    return () => unsubscribe();
  }, []); // ç©ºä¾èµ–æ•°ç»„

  // ...
}
```

> [!danger] ä¼ ç»Ÿæ¨¡å¼çš„æ ¸å¿ƒç¼ºé™·
> - **æ’•è£‚ (Tearing)**: è¿™æ˜¯æœ€ä¸¥é‡çš„é—®é¢˜ã€‚åœ¨ React çš„**å¹¶å‘æ¸²æŸ“ (Concurrent Rendering)** æ¨¡å¼ä¸‹ï¼ŒReact å¯èƒ½ä¼šåœ¨ä¸€æ¬¡æ›´æ–°ä¸­ï¼Œåˆ†æ­¥æ¸²æŸ“å¤šä¸ªç»„ä»¶ã€‚å¦‚æœåœ¨ä¸¤æ¬¡ç»„ä»¶æ¸²æŸ“çš„é—´éš™ï¼Œå¤–éƒ¨ store å‘ç”Ÿäº†å˜åŒ–ï¼Œå°±å¯èƒ½å¯¼è‡´ä¸€éƒ¨åˆ†ç»„ä»¶æ¸²æŸ“çš„æ˜¯æ—§çŠ¶æ€ï¼Œè€Œå¦ä¸€éƒ¨åˆ†æ¸²æŸ“çš„æ˜¯æ–°çŠ¶æ€ï¼Œé€ æˆ UI ç”»é¢å‡ºç°ä¸ä¸€è‡´çš„â€œæ’•è£‚â€ç°è±¡ã€‚
> - **æœåŠ¡ç«¯æ¸²æŸ“ (SSR) ä¸æ°´åˆ (Hydration) ä¸åŒ¹é…**: æœåŠ¡å™¨æ¸²æŸ“çš„ HTML ä¸å®¢æˆ·ç«¯é¦–æ¬¡æ¸²æŸ“çš„ç»“æœå¿…é¡»å®Œå…¨ä¸€è‡´ã€‚å¦‚æœå¤–éƒ¨ store çš„åˆå§‹çŠ¶æ€åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´å­˜åœ¨å·®å¼‚ï¼Œä¼šå¯¼è‡´æ°´åˆå¤±è´¥å¹¶è§¦å‘è­¦å‘Šã€‚
> - **å†—ä½™çš„æ¸²æŸ“**: `setState` çš„è°ƒç”¨æ˜¯å¼‚æ­¥çš„ï¼Œå¯èƒ½ä¼šåœ¨ React çš„æ¸²æŸ“å‘¨æœŸä¸­å¼•å‘é¢å¤–çš„ã€ä¸å¿…è¦çš„æ¸²æŸ“ã€‚
> - **æ‰‹åŠ¨è®¢é˜…ç®¡ç†**: å¼€å‘è€…å¿…é¡»æ‰‹åŠ¨ç¼–å†™ `useEffect` æ¥å¤„ç†è®¢é˜…å’Œæ¸…ç†é€»è¾‘ï¼Œå¢åŠ äº†ä»£ç çš„å¤æ‚åº¦å’Œå‡ºé”™çš„å¯èƒ½æ€§ã€‚

# `useSyncExternalStore` çš„å·¥ä½œåŸç†

`useSyncExternalStore` Hook è¢«è®¾è®¡ä¸ºä»æ ¹æœ¬ä¸Šè§£å†³ä¸Šè¿°æ‰€æœ‰é—®é¢˜ã€‚å®ƒé€šè¿‡å¼ºåˆ¶åŒæ­¥è¯»å–ï¼Œç¡®ä¿äº†åœ¨å•æ¬¡æ¸²æŸ“ä¸­æ‰€æœ‰ç»„ä»¶è·å–åˆ°çš„éƒ½æ˜¯åŒä¸€ç‰ˆæœ¬çš„çŠ¶æ€ã€‚

## Hook ç­¾å

`useSyncExternalStore` æ¥æ”¶ä¸‰ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼š 

`const state = useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot?)`

- **`subscribe(callback)`**: æ­¤å‡½æ•°è´Ÿè´£è®¢é˜…å¤–éƒ¨ storeã€‚å½“ store å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒå¿…é¡»è°ƒç”¨ä¼ å…¥çš„ `callback` å‡½æ•°ï¼Œä»¥é€šçŸ¥ React éœ€è¦è¿›è¡Œé‡æ–°æ¸²æŸ“ã€‚å®ƒè¿˜å¿…é¡»è¿”å›ä¸€ä¸ªç”¨äºå–æ¶ˆè®¢é˜…çš„æ¸…ç†å‡½æ•°ã€‚
- **`getSnapshot()`**: æ­¤å‡½æ•°å¿…é¡»**åŒæ­¥åœ°**è¿”å›å¤–éƒ¨ store çš„å½“å‰çŠ¶æ€å¿«ç…§ã€‚
- **`getServerSnapshot()` (å¯é€‰)**: æ­¤å‡½æ•°ä»…åœ¨æœåŠ¡ç«¯æ¸²æŸ“ (SSR) æ—¶è¢«è°ƒç”¨ï¼Œç”¨äºè¿”å›åœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨çš„åˆå§‹çŠ¶æ€å¿«ç…§ã€‚

> [!tip] å›è°ƒå‡½æ•°çš„èŒè´£åˆ†å·¥
> å‡½æ•°æ¥æ”¶çš„ `callback` æ˜¯ç”± **React åœ¨å†…éƒ¨åˆ›å»ºå¹¶ä¼ å…¥çš„**ã€‚å®ƒçš„å”¯ä¸€ä½œç”¨æ˜¯**é€šçŸ¥ React å¤–éƒ¨çŠ¶æ€å·²å‘ç”Ÿå˜åŒ–**ï¼Œéœ€è¦è°ƒåº¦ä¸€æ¬¡é‡æ¸²æŸ“ã€‚

## æ ¸å¿ƒæœºåˆ¶ï¼šåŸå­åŒ–çš„è®¢é˜…ä¸åŒæ­¥è¯»å–

`useSyncExternalStore` çš„å·¥ä½œæµç¨‹ç¡®ä¿äº†çŠ¶æ€è¯»å–çš„åŸå­æ€§å’Œä¸€è‡´æ€§ã€‚

```mermaid
sequenceDiagram
    participant Store as å¤–éƒ¨ Store
    participant React as React è¿è¡Œæ—¶
    participant Component as ç»„ä»¶

    Note over Store, Component: åˆå§‹æ¸²æŸ“
    React->>Component: 1. Render / Mount
    Component->>React: 2. è°ƒç”¨ useSyncExternalStore(subscribe, getSnapshot)
    React->>Store: 3. è°ƒç”¨ subscribe(notifyReact) å»ºç«‹è®¢é˜…
    React->>Store: 4. è°ƒç”¨ getSnapshot() è·å–åˆå§‹çŠ¶æ€
    Store-->>React: è¿”å› state v1
    React->>Component: 5. ä½¿ç”¨ state v1 å®Œæˆæ¸²æŸ“

    loop (æŸä¸ªæ—¶åˆ»)
        Note over Store: 6. å¤–éƒ¨ Store çŠ¶æ€å‘ç”Ÿå˜åŒ– (v1 -> v2)
        Store->>React: 7. è§¦å‘å·²è®¢é˜…çš„ notifyReact å›è°ƒ
    end

    Note over React: 8. è°ƒåº¦ä¸€æ¬¡æ–°çš„æ¸²æŸ“

    React->>Component: 9. é‡æ–°æ¸²æŸ“ç»„ä»¶
    Component->>React: 10. å†æ¬¡è°ƒç”¨ useSyncExternalStore
    React->>Store: 11. åŒæ­¥åœ°è°ƒç”¨ getSnapshot() è·å–æœ€æ–°çŠ¶æ€
    Store-->>React: è¿”å› state v2
    React->>Component: 12. ä½¿ç”¨ state v2 å®Œæˆæ­¤æ¬¡æ¸²æŸ“
```

> [!note] è§£å†³â€œæ’•è£‚â€çš„å…³é”®
> `useSyncExternalStore` è§£å†³â€œæ’•è£‚â€é—®é¢˜çš„å…³é”®åœ¨äºï¼Œå®ƒ**å¼ºåˆ¶ `getSnapshot` çš„è°ƒç”¨æ˜¯åŒæ­¥çš„ï¼Œå¹¶ä¸”å‘ç”Ÿåœ¨ React çš„æ¸²æŸ“é˜¶æ®µ**ã€‚è¿™ä¿è¯äº†åœ¨åŒä¸€æ¬¡æ¸²æŸ“ä¼ é€’ (render pass) ä¸­ï¼Œæ‰€æœ‰è®¢é˜…åŒä¸€ä¸ª store çš„ç»„ä»¶ï¼Œè°ƒç”¨ `getSnapshot` æ—¶å¾—åˆ°çš„æ°¸è¿œæ˜¯åŒä¸€ä¸ªå€¼ï¼Œä»è€Œæ ¹é™¤äº†çŠ¶æ€ä¸ä¸€è‡´çš„å¯èƒ½æ€§ã€‚

# `useSyncExternalStore` çš„åº”ç”¨å®è·µ

## è®¢é˜…ç½‘ç»œè¿æ¥çŠ¶æ€

```js
import { useSyncExternalStore } from 'react';

// 1. è®¢é˜…å‡½æ•°ï¼šç›‘å¬ online å’Œ offline äº‹ä»¶
function subscribe(callback) {
  window.addEventListener('online', callback);
  window.addEventListener('offline', callback);
  return () => {
    window.removeEventListener('online', callback);
    window.removeEventListener('offline', callback);
  };
}

// 2. å¿«ç…§å‡½æ•°ï¼šåŒæ­¥è¯»å–å½“å‰çŠ¶æ€
function getSnapshot() {
  return navigator.onLine;
}

// 3. è‡ªå®šä¹‰ Hook å°è£…
export function useOnlineStatus() {
  // getServerSnapshot åœ¨å®¢æˆ·ç«¯å¯ä»¥ä¸ getSnapshot ç›¸åŒ
  return useSyncExternalStore(subscribe, getSnapshot, getSnapshot);
}

// 4. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
function ChatIndicator() {
  const isOnline = useOnlineStatus();
  return {isOnline ? 'âœ… Online' : 'âŒ Disconnected'};
}
```

## ç›‘å¬é¡µé¢å¯è§æ€§

```js
import { useSyncExternalStore } from 'react';

// è®¢é˜…é¡µé¢å¯è§æ€§å˜åŒ–
function subscribe(callback) {
  document.addEventListener('visibilitychange', callback);
  return () => document.removeEventListener('visibilitychange', callback);
}

// è·å–å½“å‰é¡µé¢æ˜¯å¦å¯è§
function getSnapshot() {
  return document.visibilityState === 'visible';
}

// è‡ªå®šä¹‰ Hook
export function usePageVisible() {
  return useSyncExternalStore(subscribe, getSnapshot, () => true);
}

// ç»„ä»¶ç¤ºä¾‹
export function PageVisibilityIndicator() {
  const isVisible = usePageVisible();
  return <div>{isVisible ? 'é¡µé¢å¯è§ ğŸ‘€' : 'é¡µé¢éšè— ğŸ’¤'}</div>;
}
```